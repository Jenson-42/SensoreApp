@{
    ViewData["Title"] = "Upload Pressure Data";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h2>
                    <i class="bi bi-cloud-upload"></i> Upload Pressure-Mat Data (CSV)
                </h2>
                <p class="text-muted">Upload CSV files containing 32×32 sensor frame data for analysis</p>
            </div>

            <!-- Error/Success Messages -->
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> <strong>Error:</strong> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Warning"] != null)
            {
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle-fill"></i> <strong>Warning:</strong> @TempData["Warning"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill"></i> @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Upload Card -->
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-file-earmark-arrow-up"></i> Select CSV File
                    </h4>
                </div>
                <div class="card-body p-5">
                    <form asp-action="ProcessCSV" asp-controller="Upload" method="post" enctype="multipart/form-data" id="uploadForm">

                        <!-- File Upload Area -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">CSV File:</label>
                            <div class="border rounded p-4 text-center" style="border: 2px dashed #0d6efd; background-color: #f8f9fa;" id="dropZone">
                                <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #0d6efd;"></i>
                                <p class="mt-3 mb-2">
                                    <strong>Drag and drop CSV file here</strong><br>
                                    <span class="text-muted">or click to browse</span>
                                </p>
                                <input type="file" class="form-control" name="csvFile" id="csvFile" accept=".csv" required style="display: none;">
                                <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('csvFile').click()">
                                    <i class="bi bi-folder2-open"></i> Choose File
                                </button>
                            </div>
                            <div id="fileInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <strong>Selected:</strong> <span id="fileName"></span>
                                    (<span id="fileSize"></span>)
                                </div>
                            </div>
                        </div>

                        <!-- Hidden User ID (for now) -->
                        <input type="hidden" name="userId" value="1" />

                        <!-- File Requirements -->
                        <div class="alert alert-info mb-4">
                            <h6 class="alert-heading">
                                <i class="bi bi-info-circle"></i> File Requirements:
                            </h6>
                            <ul class="mb-0 small">
                                <li>File format: <strong>.csv</strong></li>
                                <li>Structure: <strong>32 columns × (32 × number of frames) rows</strong></li>
                                <li>Each frame: <strong>32 consecutive rows</strong></li>
                                <li>Values: <strong>0-4095</strong> (12-bit sensor data)</li>
                                <li>Maximum file size: <strong>50 MB</strong></li>
                                <li>Expected frames per file: <strong>~4,000 frames</strong></li>
                            </ul>
                        </div>

                        <!-- Upload Button -->
                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                                <span id="uploadBtnText">
                                    <i class="bi bi-cloud-upload"></i> Upload and Process
                                </span>
                                <span id="uploadSpinner" style="display: none;">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    Processing... This may take a few minutes
                                </span>
                            </button>
                            <a href="@Url.Action("Index", "PatientDashboard")" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>

                        @Html.AntiForgeryToken()
                    </form>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-question-circle"></i> How It Works
                    </h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2"><strong>Upload:</strong> Select your CSV file containing pressure sensor data</li>
                        <li class="mb-2"><strong>Validation:</strong> System checks file format and structure</li>
                        <li class="mb-2"><strong>Parsing:</strong> CSV is divided into individual 32×32 frames</li>
                        <li class="mb-2">
                            <strong>Analysis:</strong> For each frame, we calculate:
                            <ul>
                                <li>Peak Pressure Index (highest pressure point)</li>
                                <li>Contact Area % (coverage percentage)</li>
                                <li>Coefficient of Variation (pressure distribution)</li>
                            </ul>
                        </li>
                        <li><strong>Storage:</strong> Results are saved so you can view them later in reports </li>
                    </ol>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        const csvInput = document.getElementById('csvFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadForm = document.getElementById('uploadForm');
        const dropZone = document.getElementById('dropZone');

        // File selection handler
        csvInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                const file = this.files[0];
                displayFileInfo(file);
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.style.borderColor = '#0b5ed7';
            dropZone.style.backgroundColor = '#e7f1ff';
        });

        dropZone.addEventListener('dragleave', function(e) {
            dropZone.style.borderColor = '#0d6efd';
            dropZone.style.backgroundColor = '#f8f9fa';
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.style.borderColor = '#0d6efd';
            dropZone.style.backgroundColor = '#f8f9fa';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                csvInput.files = files;
                displayFileInfo(files[0]);
            }
        });

        // Display file information
        function displayFileInfo(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Form submission handler
        uploadForm.addEventListener('submit', function(e) {
            uploadBtn.disabled = true;
            document.getElementById('uploadBtnText').style.display = 'none';
            document.getElementById('uploadSpinner').style.display = 'inline-block';
        });
    </script>
}
